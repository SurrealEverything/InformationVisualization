---
title: "Basic EDA plots"
output: html_notebook
---


```{r}
library(RSQLite)
library(tidyverse)
library(hrbrthemes)
library(kableExtra)
con <- dbConnect(RSQLite::SQLite(), "../wildfire/FPA_FOD_20170508.sqlite")
causes <- dbGetQuery(con, "SELECT COUNT(*) AS nr, STAT_CAUSE_DESCR AS cause_name FROM Fires GROUP BY STAT_CAUSE_DESCR")
```

```{r}
causes %>%
  arrange(nr) %>%
  mutate(cause_name=factor(cause_name, cause_name)) %>%
  ggplot( aes(x=cause_name, y=nr) ) +
    geom_segment(aes(x=cause_name, xend=cause_name, y=0, yend=nr), color="darkgrey") +
    geom_point(size=4, color='#e34a33', alpha=0.9) +
    coord_flip() +
    theme_ipsum() +
    #xlab("") +
    labs(x="",y="", title = 'Main causes for wildfires') +
    theme(
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      #legend.position="none",
      #axis.text = element_text(hjust = 0.5)
    )
```

```{r}
fire_size_class <- dbGetQuery(con, "SELECT COUNT(*) AS nr, FIRE_SIZE_CLASS AS fire_size FROM Fires GROUP BY FIRE_SIZE_CLASS")
```

```{r}

fire_size_class %>%
  arrange(nr) %>%
  mutate(fire_size=factor(fire_size, fire_size)) %>%
  ggplot( aes(x=fire_size, y=nr) ) +
    #geom_segment(aes(x=cause_name, xend=fire_size, y=0, yend=nr), color="darkgrey") +
    #geom_point(size=4, color='#e34a33', alpha=0.9) +
    geom_bar(stat='identity', fill='darkred') +
    coord_flip() +
    #theme_ipsum() +
    #xlab("") +
    labs(x="",y="", title = 'Number of fires by size') +
    theme(
      panel.grid.minor.x = element_line(),
      panel.grid.minor.y = element_blank(),
      panel.grid.major.y = element_blank(),
      #axis.ticks.x = fire_size_class$nr
      #legend.position="none",
      #axis.text = element_text(hjust = 0.5)
    ) # + scale_y_discrete(fire_size_class$nr)
```

What are the most frequent causes for the biggest fires?

Note that these are normalized by column.

```{r}
fire_cause <- dbGetQuery(con,
                         "SELECT STAT_CAUSE_DESCR AS cause, FIRE_SIZE_CLASS AS fire_class, COUNT(FIRE_SIZE_CLASS) AS nr
                         FROM Fires
                         WHERE FIRE_SIZE_CLASS IN ('D', 'E', 'F', 'G')
                         GROUP BY 1, 2")


nrows <- length(levels(factor(fire_cause$cause)))
ncols <- length(levels(factor(fire_cause$fire_class)))
matr3 <- matrix(fire_cause$nr, nrow = nrows, ncol = ncols)
rownames(matr3) <- levels(factor(fire_cause$cause))
colnames(matr3) <- levels(factor(fire_cause$fire_class))
coul <- colorRampPalette(brewer.pal(8, "OrRd"))(25)
heatmap(matr3, scale = 'column', Colv = NA, Rowv = NA, col=coul)
```


```{r}
units_by_type <- dbGetQuery(con, "SELECT count(distinct(units.UnitId)), count(distinct(f.fod_id)), units.UnitType FROM Fires f INNER JOIN NWCG_UnitIDActive_20170109 units ON f.NWCG_REPORTING_UNIT_ID = units.UnitId GROUP BY units.UnitType")
```



```{r}
dbGetQuery(con, "SELECT COUNT(*), agency FROM NWCG_UnitIDActive_20170109 group by agency order by 1")


```


```{r}
# units.GeographicArea is the same as units.gacc, except that California is split into Northern California and Southern California
# as treemap?
total_burnt <- dbGetQuery(con, "SELECT sum(f.fire_size), units.gacc FROM Fires f INNER JOIN NWCG_UnitIDActive_20170109 units ON f.NWCG_REPORTING_UNIT_ID = units.UnitId GROUP BY units.gacc ORDER BY 1 DESC")


```


```{r}
parsed_datetime <- function(col_prefix) {
  glue::glue("datetime(date({col_prefix}_date) || ' ' || substr({col_prefix}_time, 1, 2) || ':' || substr({col_prefix}_time, 3, 4) || ':00')")
}

parsed_time <- function(col_prefix) {
  glue::glue("substr({col_prefix}_time, 1, 2) || ':' || substr({col_prefix}_time, 3, 4) || ':00'")
}
```

```{r}
# containment time - discovery time
dbGetQuery(con, glue::glue(
  "WITH res AS (
     SELECT
       fire_name,
       fire_size,
       discovery_date,
       cont_date,
       {parsed_datetime('f.discovery')} AS discovery,
       {parsed_datetime('f.cont')} AS contained,
       cont_date - discovery_date AS days_diff,
       time(strftime('%s', {parsed_time('cont')}) - strftime('%s', {parsed_time('discovery')}), 'unixepoch') AS h_diff,
       fire_year,
       fire_size_class
     FROM fires f
     WHERE 
           cont_date IS NOT NULL
       AND cont_time IS NOT NULL
       AND discovery_date IS NOT NULL
       AND discovery_time IS NOT NULL -- AND days_diff > 0
     ORDER BY days_diff DESC, h_diff DESC
     LIMIT 40
  )
  SELECT avg(days_diff), fire_size_class FROM res GROUP BY 2", .con=con))
  #SELECT fire_year, fire_size, discovery, contained, days_diff, h_diff FROM res", .con=con))
  #SELECT count(*) from res", .con=con))
#strftime('%s', {parsed_datetime('f.cont')}) - strftime('%s', {parsed_datetime('f.discovery')}) AS duration
```

```{r}

# ??
#dbGetQuery(con, "SELECT COUNT(*), WildlandRole FROM NWCG_UnitIDActive_20170109 GROUP BY 2")
#   COUNT(*)                 WildlandRole
# 1      328 Dispatch/Coordination Center
# 2       29            Fire/Radio Cashes
# 3        8     Incident Host Functional
# 4     5228     Incident Host Geographic
# 5      266       Resource Provider Only
# 6        8            Training Facility

# > dbGetQuery(con, "SELECT COUNT(*) FROM NWCG_UnitIDActive_20170109 WHERE Parent IS NULL")
#   COUNT(*)
# 1     5867
# > dbGetQuery(con, "SELECT COUNT(*) FROM NWCG_UnitIDActive_20170109 WHERE Parent IS NOT NULL")
#   COUNT(*)
# 1        0
```
